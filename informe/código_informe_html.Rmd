---
title: "**An√°lisis de Pobreza por Subgrupos Sociales en Estados Unidos (ACS 2016‚Äì2023)**"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br><br>

<div style="text-align: justify">
Este informe presenta un an√°lisis detallado de la evoluci√≥n de la pobreza en Estados Unidos entre 2016 y 2023, con especial atenci√≥n a las diferencias entre **subgrupos sociales** y **estados**. Utilizando datos del American Community Survey (ACS), se busca identificar patrones persistentes, brechas estructurales y din√°micas territoriales que afectan la distribuci√≥n de la pobreza.

A trav√©s de indicadores clave (KPIs), estimaciones robustas y visualizaciones interactivas, se pretende ofrecer una herramienta √∫til para investigadores, responsables de pol√≠ticas p√∫blicas y cualquier persona interesada en comprender las desigualdades socioecon√≥micas en el pa√≠s.
</div>

<br><br>

#### üß© **1. Carga de paquetes necesarios**

```{r message=TRUE, warning=FALSE, echo=FALSE}
suppressPackageStartupMessages({
  
if (!require(dplyr)) {
  install.packages("dplyr")
}
library(dplyr)

if (!require(readr)) {
  install.packages("readr")
}
library(readr)  

if (!require(purrr)) {
  install.packages("purrr")
}
library(purrr)      

if (!require(stringr)) {
  install.packages("stringr")
}
library(stringr)       

if (!require(ggplot2)) {
  install.packages("ggplot2")
}
library(ggplot2)
  
if (!require(tidyr)) {
  install.packages("tidyr")
}
library(tidyr)  
  
if (!require(patchwork)) {
  install.packages("patchwork")
}
library(patchwork)  
  
  
if (!require(knitr)) {
  install.packages("knitr")
}
library(knitr)  
  
if (!require(kableExtra)) {
  install.packages("kableExtra")
}
library(kableExtra)   

if (!require(RColorBrewer)) {
  install.packages("RColorBrewer")
}
library(RColorBrewer) 
  
if (!require(lubridate)) {
  install.packages("lubridate")
}
library(lubridate)     

if (!require(scales)) {
  install.packages("scales")
}
library(scales) 
  
if (!require(gridExtra)) {
  install.packages("gridExtra")
}
library(gridExtra)   

if (!require(cowplot)) {
  install.packages("cowplot")
}
library(cowplot)   

if (!require(grid)) {
  install.packages("grid")
}
library(grid)     

})
```

```{r echo=FALSE, results='asis'}
cat("**Paquetes cargados:** dplyr, readr, purrr, stringr, ggplot2, tidyr, patchwork, knitr, kableExtra, RColorBrewer, lubridate, scales, gridExtra, cowplot, grid.")

```

<br><br>

#### üì• **2. Lectura condicional del CSV limpio**

<div style="text-align: justify">
Este bloque realiza una **lectura condicional del archivo limpio** *df_pobreza_limpio.csv*, optimizando el tiempo de ejecuci√≥n si el dataset ya ha sido procesado previamente. En caso de que el archivo no exista, se **lee din√°micamente el conjunto completo de archivos CSV** disponibles en la carpeta *data/*, detectando autom√°ticamente el **delimitador correcto** y extrayendo el a√±o desde el nombre del archivo.

Los datos se transforman desde formato ancho a largo, se **limpian los valores num√©ricos** y se filtran las **categor√≠as sociales relevantes** para el an√°lisis de pobreza. Posteriormente, se reorganizan en formato pivotado, aplicando una funci√≥n segura para **extraer el primer valor v√°lido** en cada celda, evitando errores por valores faltantes.

Finalmente, se genera un nuevo conjunto de datos con variables clave como **poblaci√≥n total, poblaci√≥n bajo el umbral de pobreza y porcentaje de pobreza**, junto con etiquetas tem√°ticas y sociales en espa√±ol. El resultado se guarda como *df_pobreza_limpio.csv* para **futuras ejecuciones m√°s r√°pidas y reproducibles**.
</div>

```{r}
ruta_limpia <- "../data/df_pobreza_limpio.csv"

if (file.exists(ruta_limpia)) {
  df_final <- read_csv(ruta_limpia,
                       col_types = cols(
                         Fecha = col_date(),
                         Estado = col_character(),
                         Grupo_social = col_character(),
                         Tematica = col_character(),
                         Total_poblacion = col_integer(),
                         Bajo_umbral_pobreza = col_integer(),
                         Porcentaje_pobreza = col_double()
                       ))
} else {
  archivos <- list.files(path = "../data/", pattern = "*.csv", full.names = TRUE)

  leer_archivo <- function(ruta) {
    a√±o <- str_extract(ruta, "20\\d{2}")
    print(paste("Leyendo:", ruta))

    primera_linea <- readLines(ruta, n = 1)
    delim_usado <- ifelse(str_detect(primera_linea, ";"), ";", ",")

    read_delim(file = ruta, delim = delim_usado,
               col_types = cols(.default = col_character())) %>%
      mutate(Year = as.integer(a√±o))
  }

  df_completo <- map_df(archivos, leer_archivo)

  df_limpio <- df_completo %>%
    select(Year, everything()) %>%
    select(-`...314`) %>%
    pivot_longer(
      cols = -c(Year, `Label (Grouping)`),
      names_to = c("Estado", "Categoria", "Tipo"),
      names_sep = "!!",
      values_to = "valor"
    ) %>%
    rename(Grupo = `Label (Grouping)`) %>%
    mutate(
      Grupo = str_trim(Grupo),
      valor = str_remove_all(valor, "[,%¬±]"),
      valor = str_replace_all(valor, ",", ""),
      valor = na_if(valor, ""),
      valor = as.numeric(valor)
    )

  categorias_interes <- c(
    "Under 18 years", "18 to 64 years", "65 years and over",
    "Male", "Female", "White alone", "Black or African American alone",
    "Hispanic or Latino origin (of any race)",
    "Less than high school graduate", "High school graduate (includes equivalency)",
    "Bachelor's degree or higher", "Employed", "Unemployed",
    "Population for whom poverty status is determined" # NUEVA CATEGOR√çA
  )

  df_filtrado <- df_limpio %>%
    filter(!is.na(valor), Tipo == "Estimate", Grupo %in% categorias_interes) %>%
    mutate(Tematica = case_when(
      Grupo %in% c("Under 18 years", "18 to 64 years", "65 years and over") ~ "Edad",
      Grupo %in% c("Male", "Female") ~ "Sexo",
      Grupo %in% c("White alone", "Black or African American alone", 
                   "Hispanic or Latino origin (of any race)") ~ "Etnia",
      Grupo %in% c("Less than high school graduate",
                   "High school graduate (includes equivalency)",
                   "Bachelor's degree or higher") ~ "Educaci√≥n",
      Grupo %in% c("Employed", "Unemployed") ~ "Empleo",
      Grupo == "Population for whom poverty status is determined" ~ "Poblaci√≥n base"
    ))

  extraer_primero_seguro <- function(x) {
    val <- x[!is.na(x)]
    if (length(val) < 1) return(NA_real_) else return(as.numeric(val[1]))
  }

  df_pivot <- df_filtrado %>%
    pivot_wider(
      names_from = Categoria,
      values_from = valor,
      values_fn = list,
      id_cols = c(Year, Estado, Grupo, Tematica)
    ) %>%
    mutate(across(c(`Total`, `Below poverty level`, `Percent below poverty level`),
                  ~ map_dbl(.x, extraer_primero_seguro)))

  df_final <- df_pivot %>%
    mutate(
      Grupo_social = case_when(
        Grupo == "18 to 64 years" ~ "Poblaci√≥n en edad laboral",
        Grupo == "65 years and over" ~ "Personas mayores",
        Grupo == "Bachelor's degree or higher" ~ "T√≠tulo universitario",
        Grupo == "Black or African American alone" ~ "Negro o afroamericano",
        Grupo == "Employed" ~ "Empleado",
        Grupo == "Female" ~ "Femenino",
        Grupo == "High school graduate (includes equivalency)" ~ "Educaci√≥n secundaria",
        Grupo == "Hispanic or Latino origin (of any race)" ~ "Hispano o latino",
        Grupo == "Less than high school graduate" ~ "Educaci√≥n b√°sica",
        Grupo == "Male" ~ "Masculino",
        Grupo == "Under 18 years" ~ "Menores de edad",
        Grupo == "Unemployed" ~ "Desempleado",
        Grupo == "White alone" ~ "Blanco",
        Grupo == "Population for whom poverty status is determined" ~ "Poblaci√≥n evaluable para pobreza"
      ),
      Fecha = as.Date(paste0("01-01-", Year), format = "%d-%m-%Y"),
      Total_poblacion = as.integer(`Total`),
      Bajo_umbral_pobreza = as.integer(`Below poverty level`),
      Porcentaje_pobreza = `Percent below poverty level` / 100
    ) %>%
    select(
      Fecha,
      Estado,
      Grupo_social,
      Tematica,
      Total_poblacion,
      Bajo_umbral_pobreza,
      Porcentaje_pobreza
    )

  write_csv(df_final, "../data/df_pobreza_limpio.csv")
}

```

<br><br>

#### üìà **3. Estimaci√≥n robusta para el a√±o 2020**

<div style="text-align: justify">
Dado que el a√±o 2020 no cuenta con datos oficiales completos debido a la pandemia, se ha implementado una **estimaci√≥n robusta** basada en la **mediana filtrada con control de dispersi√≥n**, aplicada por grupo social y estado. Se excluyen los registros del a√±o 2020 y se seleccionan los **√∫ltimos 4 a√±os** v√°lidos (2016‚Äì2019), siempre que el **porcentaje de pobreza sea inferior al 80% y la desviaci√≥n est√°ndar no supere 0.5**.

La estimaci√≥n se calcula a partir de la **mediana del porcentaje de pobreza** y la **mediana de la poblaci√≥n total**, obtenidas sobre los a√±os seleccionados. El n√∫mero estimado de personas bajo el umbral de pobreza se obtiene como el **producto de ambas medianas**, y se genera un nuevo registro etiquetado como **"Estimado"** para el a√±o 2020 en la variable *Origen_dato*.

Este procedimiento permite **preservar la coherencia temporal del an√°lisis** y mantener la **comparabilidad entre estados y subgrupos sociales**, incluso en ausencia de datos observados directamente para ese a√±o.
</div>

```{r}
df_modelo <- df_final %>%
  filter(year(Fecha) != 2020)

estimar_2020_mediana_filtrada <- function(df_grupo, n = 4, umbral_max = 0.8, max_sd = 0.5) {
  df_grupo <- df_grupo %>%
    mutate(anio = year(Fecha)) %>%
    filter(Porcentaje_pobreza <= umbral_max)

  a√±os_validos <- sort(unique(df_grupo$anio))
  if (length(a√±os_validos) < n) return(NULL)

  a√±os_usados <- tail(a√±os_validos, n)
  df_filtrado <- df_grupo %>%
    filter(anio %in% a√±os_usados)

  sd_valor <- sd(df_filtrado$Porcentaje_pobreza, na.rm = TRUE)
  if (is.na(sd_valor) || sd_valor > max_sd) return(NULL)

  pred_pobreza <- median(df_filtrado$Porcentaje_pobreza, na.rm = TRUE)
  pred_poblacion <- round(median(df_filtrado$Total_poblacion, na.rm = TRUE))

  if (is.na(pred_pobreza) || is.na(pred_poblacion)) return(NULL)

  pred_bajo_umbral <- round(pred_pobreza * pred_poblacion)

  tibble(
    Fecha = as.Date("2020-01-01"),
    Estado = unique(df_grupo$Estado),
    Grupo_social = unique(df_grupo$Grupo_social),
    Tematica = unique(df_grupo$Tematica),
    Total_poblacion = pred_poblacion,
    Bajo_umbral_pobreza = pred_bajo_umbral,
    Porcentaje_pobreza = round(pred_pobreza, 4),
    Origen_dato = "Estimado"
  )
}

df_2020_estimado <- df_modelo %>%
  group_by(Estado, Grupo_social, Tematica) %>%
  group_split() %>%
  map_df(estimar_2020_mediana_filtrada)

```

<br><br>

#### üì¶ **4. Uni√≥n de estimaciones y exportaci√≥n final**

<div style="text-align: justify">
Este bloque une los datos originales con las **estimaciones generadas para el a√±o 2020**, asegurando que todos los registros tengan una columna expl√≠cita llamada **Origen_dato**, que permite distinguir entre datos observados y estimados. Se filtran los registros originales para excluir el a√±o 2020, y se combinan con los datos sint√©ticos previamente calculados.

El resultado es un conjunto completo que incluye tanto datos reales como estimaciones, lo que permite **mantener la continuidad temporal del an√°lisis** sin perder trazabilidad. Finalmente, se exporta el dataset consolidado como *df_pobreza_con_estimacion.csv*, listo para ser utilizado en visualizaciones, dashboards o an√°lisis posteriores.
</div>

```{r}
# A√±adimos la columna de origen a los datos originales (creamos expl√≠citamente la columna)
df_final <- df_final %>%
  mutate(Origen_dato = "Original") %>%
  filter(year(Fecha) != 2020) %>%
  bind_rows(df_2020_estimado)

# Guardamos el conjunto completo con estimaciones incluidas
write_csv(df_final, "../data/df_pobreza_con_estimacion.csv")


```

```{r}
head(df_final)
```
<br><br>

#### üìä **5. Visualizaci√≥n exploratoria y detecci√≥n de patrones**

<div style="text-align: justify">
La visualizaci√≥n de los datos permite identificar patrones relevantes en la distribuci√≥n del porcentaje de pobreza, tanto a nivel temporal como regional. Se han utilizado histogramas y boxplots para representar estas variaciones de forma clara y comparativa.

**Histogramas y Boxplots por Estado y A√±o**

Los **histogramas** muestran la evoluci√≥n mensual del porcentaje de pobreza, destacando el a√±o 2020 como estimado mediante un color azul oscuro. Esta diferenciaci√≥n permite observar posibles sesgos o desplazamientos en la distribuci√≥n durante ese a√±o, en comparaci√≥n con los datos observados.
</div>

```{r}
df_final <- df_final %>%
  mutate(Estimado = year(Fecha) == 2020)

anotacion_2020 <- df_final %>%
  filter(Estimado) %>%
  slice(1)

df_final %>%
  ggplot(aes(x = Porcentaje_pobreza, fill = Estimado)) +
  geom_histogram(binwidth = 0.01, color = "white") +
  facet_wrap(~Fecha) +
  scale_fill_manual(values = c("FALSE" = "steelblue", "TRUE" = "#08306b")) +  
  labs(title = "Distribuci√≥n del Porcentaje de Pobreza por A√±o (2020 estimado)",
       x = "% Pobreza", y = "Frecuencia") +
  scale_x_continuous(labels = scales::percent_format()) +
  theme(strip.background = element_rect(fill = "gray90", color = "gray40"),
        strip.text = element_text(face = "bold", color = "black"),
        legend.position = "none") #+
 
```
<div style="text-align: justify">
Los **boxplots** por estado revelan una alta variabilidad regional, con diferencias marcadas en la dispersi√≥n de los datos. Algunos estados presentan una concentraci√≥n m√°s estrecha en torno a la mediana, mientras que otros exhiben una mayor amplitud intercuart√≠lica y presencia de outliers extremos.
</div>

```{r}
df_final %>%
  ggplot(aes(x = Estado, y = Porcentaje_pobreza)) +
  geom_boxplot(outlier.colour = "red") +
  labs(title = "Variabilidad del Porcentaje de Pobreza por Estado", y = "% Pobreza") +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_continuous(labels = scales::percent_format())

```
<div style="text-align: justify">
Se identifican **asimetr√≠as** en la distribuci√≥n, especialmente en estados con porcentajes de pobreza elevados, lo que sugiere la existencia de subgrupos particularmente vulnerables o din√°micas locales que amplifican la desigualdad.

**Justificaci√≥n metodol√≥gica**

El histograma permite visualizar la forma de la distribuci√≥n, detectar asimetr√≠as, y delimitar los rangos t√≠picos de pobreza por fecha.

El boxplot, por su parte, facilita la detecci√≥n de valores at√≠picos (outliers) y la comparaci√≥n entre estados, destacando aquellos con mayor dispersi√≥n o comportamiento extremo.

Esta visualizaci√≥n es clave para orientar an√°lisis posteriores, como la segmentaci√≥n por subgrupos sociales o la evaluaci√≥n de pol√≠ticas focalizadas.
</div>

**Dispersi√≥n: Educaci√≥n vs Pobreza**

<div style="text-align: justify">
Este conjunto de gr√°ficos de dispersi√≥n explora c√≥mo los niveles educativos se relacionan con el porcentaje de pobreza, y si dicha relaci√≥n var√≠a a lo largo del tiempo. Cada panel representa un a√±o espec√≠fico, mostrando la relaci√≥n entre el tama√±o poblacional de cada grupo educativo y su nivel de pobreza.

Los puntos est√°n codificados por color seg√∫n el grupo educativo, y por forma seg√∫n si el dato corresponde al a√±o 2020 (tri√°ngulo) o a a√±os anteriores (c√≠rculo). Esta distinci√≥n visual permite comparar datos observados con estimaciones o reales, y detectar posibles cambios estructurales.
</div>

```{r}
df_final %>%
  filter(Tematica == "Educaci√≥n") %>%
  mutate(A√±o = year(Fecha),
         es_2020 = A√±o == 2020) %>%
  ggplot(aes(x = Total_poblacion, y = Porcentaje_pobreza)) +
  geom_point(aes(color = Grupo_social, shape = es_2020), size = 2, alpha = 0.8) +
  facet_wrap(~Fecha) +
  labs(
    title = "Relaci√≥n Educaci√≥n ‚Üî Pobreza por A√±o (2020 estimado)",
    x = "Poblaci√≥n del grupo educativo",
    y = "% Pobreza",
    color = "Grupo educativo",
    shape = "¬øEs 2020?"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_shape_manual(values = c("FALSE" = 16, "TRUE" = 17)) +  
  theme(legend.position = "bottom")


```
<div style="text-align: justify">
**Observaciones clave:**

**Relaci√≥n negativa entre educaci√≥n y pobreza:** A mayor nivel educativo, menor porcentaje de pobreza. Los grupos con educaci√≥n b√°sica o sin secundaria presentan consistentemente niveles m√°s altos de pobreza.

**Persistencia temporal:** Esta relaci√≥n se mantiene estable en las distintas fechas analizadas, lo que sugiere una correlaci√≥n estructural entre nivel educativo y vulnerabilidad econ√≥mica.

**Variabilidad entre fechas:** Aunque la tendencia general se conserva, algunos paneles muestran ligeras variaciones en la dispersi√≥n, posiblemente vinculadas a factores coyunturales o pol√≠ticas espec√≠ficas implementadas durante el a√±o 2020.

**Justificaci√≥n anal√≠tica:**

Este an√°lisis se presenta como un **ejemplo aplicado a la tem√°tica de educaci√≥n**, pero la misma l√≥gica puede extenderse a otras dimensiones disponibles en el dashboard, como **Edad, Sexo, Etnia, Educaci√≥n, Empleo**. Esto permite construir un enfoque multivariado que revele interacciones complejas entre factores de exclusi√≥n y pobreza.

Detectar si los grupos con menor nivel educativo presentan sistem√°ticamente mayor pobreza ayuda a identificar patrones persistentes de desigualdad, fundamentales para el dise√±o de pol√≠ticas p√∫blicas focalizadas. Adem√°s, si se observa una mejora en la correlaci√≥n tras un a√±o concreto, podr√≠a vincularse a intervenciones estructurales como programas de apoyo educativo, transferencias condicionadas o cambios en el mercado laboral.

**Outliers extremos: Detectar estados con valores an√≥malos por grupo social y a√±o**

Este bloque identifica **valores an√≥malos en el porcentaje de pobreza**, definidos como aquellos que superan el **percentil 95** dentro de cada grupo social y a√±o. El objetivo es detectar **estados con niveles de pobreza excepcionalmente altos**, que podr√≠an requerir atenci√≥n espec√≠fica en el an√°lisis o en el dise√±o de pol√≠ticas p√∫blicas.

**Observaciones clave:**

Se han filtrado los registros que presentan **porcentajes de pobreza superiores al 95% de su distribuci√≥n**, agrupados por fecha y grupo social.

Un ejemplo destacado es **Puerto Rico**, que muestra **valores persistentemente elevados** en grupos como **Desempleado** y **Educaci√≥n b√°sica**, con porcentajes superiores al 64% en varios a√±os consecutivos.

Estos outliers coinciden con lo observado en los **boxplots por estado**, reforzando la idea de que ciertas regiones presentan **niveles estructurales de vulnerabilidad**.
</div>

```{r}
df_outliers <-df_final %>%
  group_by(Fecha, Grupo_social) %>%
  filter(Porcentaje_pobreza > quantile(Porcentaje_pobreza, 0.95, na.rm = TRUE))  %>%
  arrange(desc(Porcentaje_pobreza)) %>%
  select(Fecha, Estado, Grupo_social, Porcentaje_pobreza)

```

```{r}
df_outliers %>%
  arrange(Fecha) %>% 
  head(5) %>%         
  kable("html") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))
```

<div style="text-align: justify">
**Justificaci√≥n anal√≠tica:**

La detecci√≥n de outliers permite **focalizar el an√°lisis en zonas cr√≠ticas**, donde la pobreza alcanza niveles extremos.

Este enfoque ayuda a **priorizar intervenciones**, evaluar el impacto de pol√≠ticas previas y dise√±ar estrategias m√°s eficaces para grupos sociales espec√≠ficos.

Adem√°s, puede servir como base para **alertas tempranas** o segmentaciones en dashboards interactivos, facilitando la toma de decisiones basada en evidencia.

<br><br>

#### üß† **6: Justificaci√≥n conceptual de los gr√°ficos del dashboard (Flex Dasboard)**

<div style="text-align: justify">
Los gr√°ficos incluidos en el dashboard han sido seleccionados estrat√©gicamente para responder a las preguntas clave del an√°lisis de pobreza. Cada visualizaci√≥n cumple una funci√≥n narrativa dentro del recorrido del usuario, desde la contextualizaci√≥n inicial hasta la toma de decisiones informadas. No representan un caso espec√≠fico, sino que ilustran c√≥mo se estructurar√≠a el dashboard para cualquier estado o tem√°tica seleccionada.

**Vector de colores personalizado**

Para garantizar una visualizaci√≥n clara, coherente y perceptivamente efectiva, se ha definido un vector de colores personalizado que codifica cada tem√°tica y grupo social del dashboard. Esta paleta cumple varias funciones clave:

**Prop√≥sito de la codificaci√≥n**

**Diferenciaci√≥n tem√°tica:** Cada dimensi√≥n social (Edad, Sexo, Etnia, Educaci√≥n, Empleo) tiene un color base que agrupa sus subcategor√≠as.

**Consistencia visual:** Los colores se mantienen constantes en todos los gr√°ficos, facilitando la lectura transversal.

**Agrupaci√≥n perceptiva:** Se aplica el principio de semejanza de la psicolog√≠a Gestalt, permitiendo al usuario identificar r√°pidamente los elementos relacionados.

**Aplicaci√≥n en el dashboard**

En gr√°ficos de l√≠neas, barras y circulares, los colores permiten distinguir grupos sociales sin necesidad de leer la leyenda.

En los KPIs, los colores refuerzan el significado sem√°ntico (por ejemplo, verde para mejora, naranja para empeoramiento).

En interacciones din√°micas, la codificaci√≥n por color facilita el seguimiento de un grupo espec√≠fico en m√∫ltiples visualizaciones.

Este vector de colores no solo mejora la est√©tica del dashboard, sino que tambi√©n potencia su capacidad comunicativa, reduciendo la carga cognitiva y aumentando la memorabilidad de los datos.
</div>

```{r}
colores_dashboard <- c(
  # Edad
  "Edad" = "#4E79A7",
  "Poblaci√≥n en edad laboral" = "#A0CBE8",
  "Personas mayores" = "#86BCB6",
  "Menores de edad" = "#499894",
  
  # Sexo
  "Sexo" = "#D37295",
  "Masculino" = "#B07AA1",
  "Femenino" = "#D4A6C8",
  
  # Etnia
  "Etnia" = "#79706E",
  "Negro o afroamericano" = "#BAB0AC",
  "Hispano o latino" = "#9D7660",
  "Blanco" = "#D7B5A6",
  
  # Educaci√≥n
  "Educaci√≥n" = "#59A14F",
  "Educaci√≥n b√°sica" = "#8CD17D",
  "Educaci√≥n secundaria" = "#B6992D",
  "T√≠tulo universitario" = "#F1CE63",
  
  # Empleo
  "Empleo" = "#E15759",
  "Empleado" = "#F28E2B" ,
  "Desempleado" = "#EDC948"
)

```

<div style="text-align: justify">
**Evoluci√≥n de la pobreza por grupo social**

Este gr√°fico de l√≠neas representa la evoluci√≥n temporal de la pobreza seg√∫n grupos de edad, utilizando como ejemplo el estado de Texas. Cada l√≠nea muestra la tasa de pobreza dentro de un grupo espec√≠fico (menores de edad, poblaci√≥n en edad laboral, personas mayores) a lo largo del tiempo. Se incluyen etiquetas en los extremos para facilitar la lectura de los valores iniciales y finales de cada serie.

**¬øQu√© revela esta visualizaci√≥n?**

Permite **comparar din√°micas entre grupos sociales**, identificando cu√°les han mejorado, empeorado o mantenido niveles estables de pobreza.

Destaca **tendencias persistentes**: por ejemplo, los menores de edad suelen presentar tasas m√°s altas que otros grupos.

Refuerza la lectura con **codificaci√≥n por color** y anotaciones clave, facilitando la interpretaci√≥n incluso sin consultar la leyenda.
</div>


```{r}
estado_seleccionado <- "Texas"
tematica_seleccionada <- "Edad"

datos <- df_final %>%
  dplyr::filter(Estado == estado_seleccionado, Tematica == tematica_seleccionada) %>%
  dplyr::group_by(Fecha, Grupo_social) %>%
  dplyr::summarise(
    Total = sum(Total_poblacion, na.rm = TRUE),
    Pobre = sum(Bajo_umbral_pobreza, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  dplyr::mutate(Pct = Pobre / Total)

if (nrow(datos) == 0) {
  stop("Sin datos para la combinaci√≥n seleccionada.")
}

extremos <- datos %>%
  dplyr::group_by(Grupo_social) %>%
  dplyr::summarise(
    Fecha_ini = first(Fecha),
    Pct_ini = first(Pct),
    Fecha_fin = last(Fecha),
    Pct_fin = last(Pct),
    .groups = "drop"
  )

ggplot(datos, aes(x = Fecha, y = Pct, color = Grupo_social)) +
  geom_line(linewidth = 1.2) +
  geom_text(data = extremos,
            aes(x = Fecha_ini, y = Pct_ini, label = scales::percent(Pct_ini, accuracy = 0.1)),
            color = "black", hjust = -0.1, vjust = 1.2, size = 3, inherit.aes = FALSE) +
  geom_text(data = extremos,
            aes(x = Fecha_fin, y = Pct_fin, label = scales::percent(Pct_fin, accuracy = 0.1)),
            color = "black", hjust = 1.1, vjust = -0.6, size = 3, inherit.aes = FALSE) +
  scale_color_manual(values = colores_dashboard) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = paste("Evoluci√≥n de pobreza por grupo ‚Äì", estado_seleccionado),
    subtitle = "Tasa de pobreza (% dentro de cada grupo) a lo largo del tiempo\nIncluye valores iniciales y finales por grupo",
    x = NULL, y = "% pobreza", color = "Grupo"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")


```
<div style="text-align: justify"> 
**Distribuci√≥n de la pobreza por grupo social ‚Äì a√±o m√°s reciente**

Este gr√°fico circular muestra la composici√≥n total de personas en situaci√≥n de pobreza, desglosada por grupo social en el a√±o m√°s reciente disponible. A diferencia de los gr√°ficos que analizan tasas internas dentro de cada grupo, esta visualizaci√≥n se enfoca en el volumen absoluto de personas pobres que pertenecen a cada categor√≠a.

**¬øQu√© revela esta visualizaci√≥n?**

Permite **dimensionar el peso relativo de cada grupo** dentro del total de pobreza, independientemente de su tama√±o poblacional o de su tasa espec√≠fica.

Destaca que ciertos grupos, como la poblaci√≥n en edad laboral o los menores de edad, pueden representar una **proporci√≥n significativa del total**, lo que orienta la priorizaci√≥n de pol√≠ticas p√∫blicas.

Refuerza la lectura con **codificaci√≥n por color** y etiquetas integradas, facilitando la interpretaci√≥n directa de porcentajes y vol√∫menes sin necesidad de consultar leyendas externas.

Complementa los gr√°ficos de evoluci√≥n temporal, ofreciendo una **visi√≥n transversal** que conecta tasas relativas con distribuci√≥n absoluta. </div>

```{r}
estado_seleccionado <- "Texas"
tematica_seleccionada <- "Edad"

ultimo <- df_final %>%
  dplyr::filter(Estado == estado_seleccionado, Tematica == tematica_seleccionada) %>%
  dplyr::summarise(Fecha = max(Fecha, na.rm = TRUE)) %>%
  dplyr::pull(Fecha)

if (length(ultimo) != 1 || !is.finite(ultimo)) {
  stop("No hay fecha v√°lida para esta combinaci√≥n.")
}

datos <- df_final %>%
  dplyr::filter(Estado == estado_seleccionado,
                Tematica == tematica_seleccionada,
                Fecha == ultimo) %>%
  dplyr::group_by(Grupo_social) %>%
  dplyr::summarise(
    Pobre = sum(Bajo_umbral_pobreza, na.rm = TRUE),
    Total = sum(Total_poblacion, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  dplyr::mutate(Pobre = dplyr::if_else(is.na(Pobre), 0, Pobre)) %>%
  dplyr::filter(Pobre > 0)

if (nrow(datos) == 0) {
  stop(paste0("Sin datos de pobreza para ", format(ultimo, "%Y-%m-%d"), "."))
}

suma_pobre <- sum(datos$Pobre, na.rm = TRUE)
if (suma_pobre == 0) {
  stop("No hay personas bajo pobreza en la fecha seleccionada.")
}

datos <- datos %>%
  dplyr::mutate(
    Pct = Pobre / suma_pobre,
    etiqueta = paste0(scales::percent(Pct, accuracy = 0.1), "\n(n=", scales::comma(Pobre), ")")
  ) %>%
  dplyr::arrange(desc(Pct))

paleta <- colores_dashboard[names(colores_dashboard) %in% datos$Grupo_social]

ggplot(datos, aes(x = 2, y = Pct, fill = Grupo_social)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  xlim(0.5, 2.5) +
  geom_text(aes(label = etiqueta),
            position = position_stack(vjust = 0.5),
            size = 3, lineheight = 0.9) +
  scale_fill_manual(values = paleta) +
  labs(
    title = paste("Distribuci√≥n de personas bajo pobreza ‚Äì", lubridate::year(ultimo)),
    subtitle = "Participaci√≥n por grupo dentro del total de personas pobres (volumen abs.)",
    x = NULL, y = NULL, fill = "Grupo",
    caption = "Nota: este gr√°fico muestra la composici√≥n total; la l√≠nea anterior refleja tasas de pobreza dentro de cada grupo."
  ) +
  theme_void() +
  theme(
    legend.position = "bottom",
    plot.subtitle = element_text(size = 10, face = "italic"),
    plot.caption = element_text(size = 8, color = "grey40")
  )

```

<div style="text-align: justify"> 
**Aportaci√≥n al total de pobreza por tem√°tica**

Este gr√°fico de barras muestra la **distribuci√≥n de personas pobres seg√∫n distintas tem√°ticas sociales** en el a√±o m√°s reciente disponible. Cada barra representa el **porcentaje del total de pobreza** que corresponde a una categor√≠a espec√≠fica, como etnia, edad, sexo o nivel educativo.

**¬øQu√© revela esta visualizaci√≥n?**

Permite **comparar el peso relativo de cada tem√°tica** en la composici√≥n total de la pobreza, destacando cu√°les concentran m√°s personas afectadas.

Las etiquetas integradas muestran tanto el **porcentaje como el n√∫mero absoluto de personas**, lo que facilita una lectura directa sin necesidad de consultar leyendas externas.

Este gr√°fico es √∫til para **identificar ejes prioritarios de intervenci√≥n**: si ciertas tem√°ticas agrupan mayor cantidad de personas pobres, podr√≠an requerir pol√≠ticas m√°s focalizadas en inclusi√≥n, equidad o acceso a oportunidades.

Complementa las visualizaciones anteriores al ofrecer una **perspectiva tem√°tica transversal**, que ayuda a entender c√≥mo se distribuye la pobreza m√°s all√° de los grupos demogr√°ficos cl√°sicos. </div>

```{r}
estado_seleccionado <- "Texas"

tematicas_deseadas <- c("Etnia", "Edad", "Sexo", "Educaci√≥n")

ultimo <- df_final %>%
  dplyr::filter(Estado == estado_seleccionado) %>%
  dplyr::summarise(Fecha = max(Fecha, na.rm = TRUE)) %>%
  dplyr::pull(Fecha)

if (length(ultimo) != 1 || !is.finite(ultimo)) {
  stop("No hay fecha v√°lida para esta combinaci√≥n.")
}

datos <- df_final %>%
  dplyr::filter(Estado == estado_seleccionado,
                Fecha == ultimo,
                Tematica %in% tematicas_deseadas) %>%
  dplyr::group_by(Tematica) %>%
  dplyr::summarise(Pobre = sum(Bajo_umbral_pobreza, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(
    Pct = Pobre / sum(Pobre),
    etiqueta = paste0(scales::percent(Pct, accuracy = 0.1), "\n(n=", scales::comma(Pobre), ")")
  ) %>%
  dplyr::arrange(desc(Pct))

if (nrow(datos) == 0) {
  stop("Sin datos de pobreza para las tem√°ticas seleccionadas.")
}

paleta <- colores_dashboard[names(colores_dashboard) %in% datos$Tematica]

ggplot(datos, aes(x = reorder(Tematica, -Pct), y = Pct, fill = Tematica)) +
  geom_col() +
  geom_text(aes(label = etiqueta), vjust = -0.4, size = 3, color = "black", lineheight = 0.9) +
  scale_fill_manual(values = paleta) +
  scale_y_continuous(labels = scales::percent_format(), expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = paste("Aportaci√≥n al total de pobreza ‚Äì", lubridate::year(ultimo)),
    subtitle = "Distribuci√≥n de personas pobres por tem√°tica (suma = 100%)",
    x = "Tem√°tica", y = "% del total de personas bajo pobreza"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```
<div style="text-align: justify"> 
**Distribuci√≥n dentro de la poblaci√≥n pobre ‚Äì por situaci√≥n laboral**

Este gr√°fico de barras muestra la **composici√≥n interna de la poblaci√≥n pobre** seg√∫n su situaci√≥n laboral en el a√±o m√°s reciente disponible. Cada barra representa el porcentaje de personas pobres que se encuentran en cada grupo laboral, como empleados o desempleados.

**¬øQu√© revela esta visualizaci√≥n?**

Destaca que una **gran mayor√≠a de personas pobres est√°n empleadas**, lo que sugiere que el empleo no garantiza condiciones suficientes para salir de la pobreza. Esto puede estar vinculado a **bajos salarios, empleos informales o falta de protecci√≥n social**.

Las etiquetas integradas permiten leer de forma directa tanto el **porcentaje como el n√∫mero absoluto de personas**, facilitando la interpretaci√≥n sin necesidad de consultar leyendas externas.

Este gr√°fico es clave para **replantear pol√≠ticas laborales y sociales**: si la pobreza afecta mayoritariamente a personas con empleo, se requieren estrategias que aborden la calidad del trabajo, el acceso a derechos laborales y los ingresos m√≠nimos.

Complementa las visualizaciones anteriores al ofrecer una **mirada funcional sobre la pobreza**, centrada en la relaci√≥n entre empleo y vulnerabilidad econ√≥mica. 
</div>

```{r}
estado_seleccionado <- "Texas"

ultimo <- df_final %>%
  dplyr::filter(Estado == estado_seleccionado) %>%
  dplyr::summarise(Fecha = max(Fecha, na.rm = TRUE)) %>%
  dplyr::pull(Fecha)

if (length(ultimo) != 1 || !is.finite(ultimo)) {
  stop("No hay fecha v√°lida para esta combinaci√≥n.")
}

datos <- df_final %>%
  dplyr::filter(Estado == estado_seleccionado,
                Tematica == "Empleo",
                Fecha == ultimo) %>%
  dplyr::group_by(Grupo_social) %>%
  dplyr::summarise(Pobre = sum(Bajo_umbral_pobreza, na.rm = TRUE), .groups = "drop") %>%
  dplyr::mutate(Pct = Pobre / sum(Pobre)) %>%
  dplyr::arrange(desc(Pct))

if (nrow(datos) == 0) {
  stop("Sin datos de 'Empleo' para la fecha actual.")
}

paleta <- colores_dashboard[names(colores_dashboard) %in% datos$Grupo_social]

ggplot(datos, aes(x = reorder(Grupo_social, -Pct), y = Pct, fill = Grupo_social)) +
  geom_col() +
  geom_text(aes(label = paste0(scales::percent(Pct, accuracy = 0.1), "\nN = ", scales::comma(Pobre))),
            vjust = -0.6, size = 3.3) +
  scale_fill_manual(values = paleta) +
  scale_y_continuous(labels = scales::percent_format(), expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "Distribuci√≥n dentro de la poblaci√≥n pobre",
    subtitle = "Por situaci√≥n laboral",
    x = "Grupo laboral",
    y = "% dentro del total en pobreza"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

```

<div style="text-align: justify"> 
**Indicadores clave de pobreza ‚Äì evoluci√≥n temporal**

Este bloque presenta los **principales indicadores de pobreza** en el estado seleccionado, calculados sobre la poblaci√≥n evaluable para pobreza. Se incluyen tres m√©tricas clave: el porcentaje actual, el cambio anual y la variaci√≥n acumulada en cinco a√±os.

**% pobreza actual (2023):**

Representa la proporci√≥n de personas bajo pobreza en el a√±o m√°s reciente disponible. Este valor resume el estado actual del fen√≥meno en t√©rminos relativos.

**Crecimiento anual (desde 2022):**

Indica una reducci√≥n interanual en la tasa de pobreza, lo que sugiere una mejora o empeoramiento reciente en las condiciones socioecon√≥micas o en la cobertura de programas sociales.

**Crecimiento en 5 a√±os (desde 2018):**

Refleja una **tendencia descendente o creciente**, lo que puede atribuirse a cambios estructurales, pol√≠ticas p√∫blicas efectivas o din√°micas demogr√°ficas.

Estos KPIs permiten **monitorear el progreso** en la lucha contra la pobreza, identificar puntos de inflexi√≥n y evaluar el impacto de intervenciones a lo largo del tiempo. Su lectura integrada con los gr√°ficos anteriores ofrece una **visi√≥n completa y estrat√©gica** del fen√≥meno. 
</div>

```{r}
df_kpi_texas <- df_final %>%
  dplyr::filter(Estado == "Texas", Grupo_social == "Poblaci√≥n evaluable para pobreza") %>%
  dplyr::mutate(A√±o = lubridate::year(Fecha)) %>%
  dplyr::group_by(A√±o) %>%
  dplyr::summarise(
    Pob_evaluable = sum(Total_poblacion, na.rm = TRUE),
    Pob_pobre = sum(Bajo_umbral_pobreza, na.rm = TRUE),
    Porcentaje_pobreza = Pob_pobre / Pob_evaluable,
    .groups = "drop"
  ) %>%
  dplyr::arrange(A√±o)

a√±o_actual <- max(df_kpi_texas$A√±o)
a√±o_anterior <- a√±o_actual - 1
a√±o_hace_5 <- max(df_kpi_texas$A√±o[df_kpi_texas$A√±o <= a√±o_actual - 5])

valor_actual <- df_kpi_texas %>% dplyr::filter(A√±o == a√±o_actual) %>% dplyr::pull(Porcentaje_pobreza)
valor_anterior <- df_kpi_texas %>% dplyr::filter(A√±o == a√±o_anterior) %>% dplyr::pull(Porcentaje_pobreza)
valor_hace_5 <- df_kpi_texas %>% dplyr::filter(A√±o == a√±o_hace_5) %>% dplyr::pull(Porcentaje_pobreza)

crecimiento_anual <- if(length(valor_anterior) > 0) {
  (valor_actual - valor_anterior) / valor_anterior
} else { NA }

crecimiento_5_anos <- if(length(valor_hace_5) > 0) {
  (valor_actual - valor_hace_5) / valor_hace_5
} else { NA }

cat("üìå % pobreza actual (", a√±o_actual, "): ",
    scales::percent(valor_actual, accuracy = 0.1), "\n")

if (!is.na(crecimiento_anual)) {
  cat("üìà Crecimiento anual (desde ", a√±o_anterior, "): ",
      scales::percent(crecimiento_anual, accuracy = 0.1), "\n")
} else {
  cat("üìà Crecimiento anual: No disponible\n")
}

if (!is.na(crecimiento_5_anos)) {
  cat("üìä Crecimiento en 5 a√±os (desde ", a√±o_hace_5, "): ",
      scales::percent(crecimiento_5_anos, accuracy = 0.1), "\n")
} else {
  cat("üìä Crecimiento en 5 a√±os: No disponible\n")
}

```
